<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logos de Repuestos - Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
<style>
  :root {
    --hansair-blue: #004a80;         /* header / botones principales   */
    --hansair-blue-dark: #00345a;    /* hover                         */
    --hansair-blue-light: #e5eff7;   /* fondos suaves / stripes       */
    --hansair-yellow: #ffc800;       /* acentos (opcional)            */
    --hansair-bg: #f5f5f5;           /* fondo general                 */
    --hansair-card-bg: #ffffff;      /* tarjetas / tablas             */
    --hansair-border: #d1d5db;       /* bordes suaves                 */
    --hansair-text-main: #111827;    /* texto principal (casi negro)  */
    --hansair-text-muted: #6b7280;   /* texto secundario              */
  }

  body {
    background: var(--hansair-bg);
    color: var(--hansair-text-main);
  }

  .navbar {
    background: var(--hansair-blue);
    border-bottom: 2px solid #ffffff;
  }

  .navbar-brand,
  .navbar .navbar-text {
    color: #ffffff !important;
  }

  .brand-logo {
    height: 28px;
  }

  .card {
    background: var(--hansair-card-bg);
    border: 1px solid var(--hansair-border);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    color: var(--hansair-text-main);
  }

  .text-secondary {
    color: var(--hansair-text-muted) !important;
  }

  .small-label {
    font-size: 0.8rem;
    color: var(--hansair-text-muted);
    letter-spacing: 0.02em;
  }

  /* Inputs y selects */
  .form-control,
  .form-select {
    background: #ffffff;
    color: var(--hansair-text-main);
    border-color: var(--hansair-border);
  }

  .form-control:focus,
  .form-select:focus {
    box-shadow: 0 0 0 0.15rem rgba(0, 74, 128, 0.35);
    border-color: var(--hansair-blue);
    background: #ffffff;
    color: var(--hansair-text-main);
  }

  .form-control::placeholder {
    color: #9ca3af;
    opacity: 1;
  }

  /* Botones */
  .btn-primary {
    background: var(--hansair-blue);
    border-color: var(--hansair-blue);
    color: #ffffff;
    font-weight: 600;
  }

  .btn-primary:hover {
    background: var(--hansair-blue-dark);
    border-color: var(--hansair-blue-dark);
  }

  .btn-outline-light {
    border-color: var(--hansair-blue);
    color: var(--hansair-blue);
    background: transparent;
    font-weight: 500;
  }

  .btn-outline-light:hover {
    background: var(--hansair-blue);
    color: #ffffff;
  }

  .badge-pill {
    border-radius: 999px;
  }

  /* Tabs */
  .tab-btn {
    border-color: var(--hansair-border);
    color: var(--hansair-text-main);
    background: #ffffff;
  }

  .tab-btn.active {
    background: var(--hansair-blue) !important;
    color: #ffffff !important;
    border-color: var(--hansair-blue) !important;
  }

/* Tabla */
.table-dark {
  --bs-table-bg: #ffffff;
  --bs-table-striped-bg: var(--hansair-blue-light);
  --bs-table-striped-color: var(--hansair-text-main);
  --bs-table-border-color: var(--hansair-border);
  --bs-table-color: var(--hansair-text-main);   /* üëà clave: texto oscuro */
}

/* encabezado con fondo azul y texto blanco */
.table-dark thead th {
  background: var(--hansair-blue);
  color: #ffffff;
  border-bottom-color: var(--hansair-blue-dark);
}

/* cuerpo de la tabla: texto oscuro siempre */
.table-dark tbody td,
.table-dark tbody th {
  color: var(--hansair-text-main);
}

.table-dark tbody tr:hover {
  background-color: #dde8f3;
}


  /* Modal */
  .modal-content {
    background: #ffffff;
    color: var(--hansair-text-main);
    border: 1px solid var(--hansair-border);
  }

  .modal-header,
  .modal-footer {
    border-color: var(--hansair-border);
  }

  .btn-close.btn-close-white {
    filter: invert(0); /* como el fondo es blanco, usamos el close normal */
  }

  details summary {
    cursor: pointer;
  }

  code {
    background: var(--hansair-blue-light);
    color: var(--hansair-blue-dark);
    padding: 0.1rem 0.35rem;
    border-radius: 999px;
    font-size: 0.85em;
  }
</style>

</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">
        Cat√°logos Repuestos
      </a>
      <span class="navbar-text small text-secondary">
        Demo de avances ¬∑ FastAPI + Base de datos
      </span>
    </div>
  </nav>

  <div class="container mb-5">
    <!-- HEADER / RESUMEN -->
    <div class="row g-3 mb-4">
      <div class="col-md-8">
        <div class="card h-100">
          <div class="card-body">
            <h4 class="card-title mb-2">Vista de demostraci√≥n</h4>
            <p class="mb-2">
              Esta interfaz muestra los <strong>avances de la app</strong>:
            </p>
            <ul class="mb-0">
              <li>B√∫squeda unificada de repuestos por c√≥digo o descripci√≥n.</li>
              <li>Visualizaci√≥n de informaci√≥n clave de cada pieza.</li>
              <li>Carga de nuevos cat√°logos en Excel/PDF hacia el backend.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- ‚ÄúM√©tricas‚Äù / estado (demo) -->
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-secondary small mb-2">Estado (demo)</h6>
            <div class="d-flex justify-content-between mb-2">
              <span class="small-label">Cat√°logos cargados</span>
              <span class="badge bg-primary badge-pill" id="statCatalogs">‚Äì</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="small-label">Repuestos en BD</span>
              <span class="badge bg-success badge-pill" id="statParts">‚Äì</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="small-label">√öltima actualizaci√≥n</span>
              <span class="small" id="statUpdated">‚Äì</span>
            </div>
            <div class="mt-3 small text-secondary">
              * Puedes conectar estos n√∫meros a un endpoint como
              <code>/stats</code> m√°s adelante.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <div class="mb-3">
      <div class="btn-group" role="group">
        <button
          type="button"
          class="btn btn-outline-light tab-btn active"
          data-target="#tab-search"
        >
          üîç Buscar repuesto
        </button>
        <button
          type="button"
          class="btn btn-outline-light tab-btn"
          data-target="#tab-upload"
        >
          üì§ Cargar cat√°logo
        </button>
      </div>
    </div>

    <!-- TAB: BUSCAR -->
    <div id="tab-search" class="tab-content-section">
      <!-- BUSCADOR -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Buscar repuestos</h5>
          <form id="searchForm" class="row g-3">
            <div class="col-md-5">
              <label class="form-label small-label">C√≥digo o descripci√≥n</label>
              <input
                type="text"
                class="form-control"
                id="searchQuery"
                placeholder="Ej: 10296, Light Diffuser, etc."
                required
              />
            </div>
            <div class="col-md-3">
              <label class="form-label small-label">Proveedor (opcional)</label>
              <input
                type="text"
                class="form-control"
                id="searchVendor"
                placeholder="Ej: STUKERJURGEN"
              />
            </div>
            <div class="col-md-2">
              <label class="form-label small-label">Moneda (opcional)</label>
              <select class="form-select" id="searchCurrency">
                <option value="">Todas</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary w-100" type="submit">
                Buscar
              </button>
            </div>
          </form>
          <div id="searchStatus" class="mt-2 small text-secondary"></div>
        </div>
      </div>

      <!-- RESULTADOS -->
      <div class="card">
        <div class="card-body">
          <h6 class="mb-3 text-secondary">Resultados</h6>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th>Proveedor</th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody id="resultsBody">
                <tr>
                  <td colspan="4" class="text-center text-secondary">
                    Sin resultados todav√≠a. Realiza una b√∫squeda.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="resultsCount" class="small text-secondary mt-2"></div>
        </div>
      </div>
    </div>

    <!-- TAB: UPLOAD -->
    <div id="tab-upload" class="tab-content-section" style="display: none;">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Cargar nuevo cat√°logo</h5>
          <p class="small text-secondary">
            Aqu√≠ puedes subir archivos Excel o PDF de proveedores como Panasonic,
            Stukerjurgen, Airtec, etc. El backend se encarga de leerlos y
            normalizar los repuestos.
          </p>

          <form id="uploadForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label small-label">Archivo</label>
              <input
                class="form-control"
                type="file"
                id="catalogFile"
                accept=".xlsx,.xls,.pdf"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label small-label">Proveedor / Cat√°logo</label>
              <input
                type="text"
                class="form-control"
                id="catalogVendor"
                placeholder="Ej: PANASONIC SPPC2023"
                required
              />
            </div>
            <div class="col-md-2">
              <label class="form-label small-label">Moneda (para mostrar)</label>
              <select class="form-select" id="catalogCurrency" required>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary w-100" type="submit">
                Subir
              </button>
            </div>
          </form>

          <div id="uploadStatus" class="mt-3 small"></div>

          <hr class="border-secondary my-4" />

          <div class="small text-secondary">
            </em>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE AMIGABLE -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:#020617;color:#e5e7eb;">
        <div class="modal-header">
          <h5 class="modal-title" id="detailTitle">Detalle del repuesto</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="small text-secondary mb-3">
            Aqu√≠ se muestra toda la informaci√≥n del producto de forma resumida y entendible.
          </p>

          <!-- Contenido amigable -->
          <div id="detailContent"></div>

          <hr class="border-secondary my-3" />

          <!-- JSON crudo, solo si alguien quiere verlo -->
          <details class="small text-secondary">
            <summary>Ver JSON completo (modo desarrollador)</summary>
            <pre id="detailJsonRaw" style="background:#020617;border-radius:0.5rem;padding:1rem;font-size:0.8rem;max-height:40vh;overflow:auto;"></pre>
          </details>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "http://localhost:8000";
    let lastResults = [];

    // ----- Tabs -----
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabSections = document.querySelectorAll(".tab-content-section");
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const target = btn.getAttribute("data-target");
        tabSections.forEach((sec) => {
          sec.style.display = sec.id === target.substring(1) ? "block" : "none";
        });
      });
    });

    // Helpers
    function formatLabel(key) {
      return key
        .replace(/_/g, " ")
        .replace(/\b\w/g, (ch) => ch.toUpperCase());
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // ----- Detalle amigable -----
    function showDetail(index) {
      const item = lastResults[index];
      if (!item) return;

      const code = item.part_number_full || item.part_number_root || "";
      const desc = item.description || "";

      const titleEl = document.getElementById("detailTitle");
      const contentEl = document.getElementById("detailContent");
      const rawPreEl = document.getElementById("detailJsonRaw");

      if (code && desc) {
        titleEl.textContent = `${code} ‚Äì ${desc}`;
      } else if (code) {
        titleEl.textContent = `Detalle de ${code}`;
      } else {
        titleEl.textContent = "Detalle del repuesto";
      }

      rawPreEl.textContent = JSON.stringify(item, null, 2);

      const mainRows = [];
      mainRows.push(["C√≥digo completo", code || "‚Äì"]);
      mainRows.push(["C√≥digo ra√≠z", item.part_number_root || "‚Äì"]);
      mainRows.push(["Descripci√≥n", desc || "‚Äì"]);

      // üëá aqu√≠ preferimos supplier_name y dejamos los otros como fallback
      const proveedor =
        item.supplier_name ||
        (item.supplier && item.supplier.name) ||
        item.vendor_name ||
        (item.catalog && item.catalog.supplier_name) ||
        item.catalog_source ||
        "‚Äì";

      mainRows.push(["Proveedor", proveedor]);

      const moneda = item.currency || "‚Äì";
      const basePrice =
        item.base_price !== undefined && item.base_price !== null
          ? item.base_price.toFixed(2)
          : "‚Äì";

      mainRows.push(["Moneda base", moneda]);
      mainRows.push(["Precio base", basePrice]);

      if (item.min_qty_default !== undefined && item.min_qty_default !== null) {
        mainRows.push(["Cantidad m√≠nima por defecto", item.min_qty_default]);
      }

      let html = `
        <h6 class="mb-2">Informaci√≥n general</h6>
        <table class="table table-sm table-dark mb-3">
          <tbody>
            ${mainRows
              .map(
                ([label, value]) => `
              <tr>
                <th style="width:35%;">${escapeHtml(label)}</th>
                <td>${escapeHtml(value)}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
      `;

      const tiers = Array.isArray(item.price_tiers) ? item.price_tiers : [];
      if (tiers.length) {
        html += `
          <h6 class="mb-2">Tramos de precio</h6>
          <table class="table table-sm table-dark mb-3">
            <thead>
              <tr>
                <th>Cant. m√≠nima</th>
                <th>Cant. m√°xima</th>
                <th>Precio unitario</th>
                <th>Moneda</th>
              </tr>
            </thead>
            <tbody>
              ${tiers
                .map((t) => {
                  const minq = t.min_qty ?? "‚Äì";
                  const maxq = t.max_qty ?? "‚Äì";
                  const unitPrice =
                    t.unit_price !== undefined && t.unit_price !== null
                      ? t.unit_price.toFixed(2)
                      : "‚Äì";
                  const cur = t.currency || moneda || "‚Äì";
                  return `
                    <tr>
                      <td>${escapeHtml(minq)}</td>
                      <td>${escapeHtml(maxq)}</td>
                      <td>${escapeHtml(unitPrice)}</td>
                      <td>${escapeHtml(cur)}</td>
                    </tr>
                  `;
                })
                .join("")}
            </tbody>
          </table>
        `;
      }

      const attrs =
        item.attributes ||
        item.extra_attributes ||
        [];

      if (Array.isArray(attrs) && attrs.length) {
        html += `
          <h6 class="mb-2">Informaci√≥n espec√≠fica del cat√°logo</h6>
          <table class="table table-sm table-dark mb-3">
            <thead>
              <tr>
                <th>Atributo</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              ${attrs
                .map((a) => {
                  const name = a.attr_name || a.name || "‚Äì";
                  const value = a.attr_value || a.value || "‚Äì";
                  return `
                    <tr>
                      <td>${escapeHtml(name)}</td>
                      <td>${escapeHtml(value)}</td>
                    </tr>
                  `;
                })
                .join("")}
            </tbody>
          </table>
        `;
      }

      const usedKeys = new Set([
        "part_number_full",
        "part_number_root",
        "description",
        "currency",
        "base_price",
        "min_qty_default",
        "supplier",
        "supplier_name",   // üëà a√±adimos supplier_name para que no salga en ‚ÄúOtros‚Äù
        "vendor_name",
        "catalog",
        "catalogs",
        "catalog_source",
        "price_tiers",
        "attributes",
        "extra_attributes",
      ]);

      const otherRows = [];
      for (const [key, val] of Object.entries(item)) {
        if (usedKeys.has(key)) continue;
        if (val === null || val === undefined) continue;
        let display;
        if (Array.isArray(val) || typeof val === "object") {
          display = "[ver en JSON completo]";
        } else {
          display = String(val);
        }
        otherRows.push([formatLabel(key), display]);
      }

      if (otherRows.length) {
        html += `
          <h6 class="mb-2">Otros campos</h6>
          <table class="table table-sm table-dark mb-1">
            <tbody>
              ${otherRows
                .map(
                  ([label, value]) => `
                <tr>
                  <th style="width:35%;">${escapeHtml(label)}</th>
                  <td>${escapeHtml(value)}</td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          </table>
          <p class="small text-secondary">
            Para m√°s detalle de estos campos, abre el JSON completo al final.
          </p>
        `;
      }

      contentEl.innerHTML = html;

      const modalEl = document.getElementById("detailModal");
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }

    // ----- Buscar repuestos -----
    const searchForm = document.getElementById("searchForm");
    const searchStatus = document.getElementById("searchStatus");
    const resultsBody = document.getElementById("resultsBody");
    const resultsCount = document.getElementById("resultsCount");

    searchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const query = document.getElementById("searchQuery").value.trim();
      const vendor = document.getElementById("searchVendor").value.trim();
      const currency = document.getElementById("searchCurrency").value;

      if (!query) return;

      searchStatus.textContent = "Buscando repuestos...";
      resultsBody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-secondary">
            Cargando resultados...
          </td>
        </tr>
      `;
      resultsCount.textContent = "";

      try {
        const params = new URLSearchParams({ q: query });
        if (vendor) params.append("vendor", vendor);
        if (currency) params.append("currency", currency);

        const resp = await fetch(`${API_BASE}/parts/search?` + params.toString());
        if (!resp.ok) {
          throw new Error("Error al consultar la API");
        }

        const data = await resp.json();
        const results = Array.isArray(data) ? data : data.items || [];
        lastResults = results;

        if (!results.length) {
          resultsBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-secondary">
                No se encontraron repuestos para esta b√∫squeda.
              </td>
            </tr>
          `;
          resultsCount.textContent = "";
          searchStatus.textContent = "Sin resultados.";
          return;
        }

        resultsBody.innerHTML = "";
        results.forEach((item, idx) => {
          const codigo = item.part_number_full || item.part_number_root || "-";
          const desc = item.description || "-";

          // üëá preferimos supplier_name, si viene del backend nuevo
          const proveedor =
            item.supplier_name ||
            (item.supplier && item.supplier.name) ||
            item.vendor_name ||
            (item.catalog && item.catalog.supplier_name) ||
            item.catalog_source ||
            "-";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><code>${codigo}</code></td>
            <td>${desc}</td>
            <td>${proveedor}</td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-outline-light"
                      data-detail-index="${idx}">
                Ver
              </button>
            </td>
          `;
          resultsBody.appendChild(tr);
        });

        document.querySelectorAll("button[data-detail-index]").forEach((btn) => {
          btn.addEventListener("click", (ev) => {
            const idx = parseInt(ev.currentTarget.getAttribute("data-detail-index"), 10);
            showDetail(idx);
          });
        });

        resultsCount.textContent = `${results.length} repuesto(s) encontrados.`;
        searchStatus.textContent = "B√∫squeda completada.";
      } catch (err) {
        console.error(err);
        resultsBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-danger">
              Ocurri√≥ un error al buscar. Revisa que el backend est√© levantado.
            </td>
          </tr>
        `;
        searchStatus.textContent = "Error al buscar repuestos.";
      }
    });

    // ----- Subir cat√°logo -----
    const uploadForm = document.getElementById("uploadForm");
    const uploadStatus = document.getElementById("uploadStatus");

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("catalogFile");
      const vendorInput = document.getElementById("catalogVendor");
      const currencyInput = document.getElementById("catalogCurrency");

      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("supplier_name", vendorInput.value);
      formData.append("year", new Date().getFullYear());

      uploadStatus.textContent = "Subiendo cat√°logo...";
      uploadStatus.className = "mt-3 small text-secondary";

      try {
        const resp = await fetch(`${API_BASE}/catalogs/upload`, {
          method: "POST",
          body: formData,
        });

        if (!resp.ok) {
          const errorText = await resp.text();
          throw new Error(errorText || "Error al subir cat√°logo");
        }

        await resp.json().catch(() => ({}));

        uploadStatus.textContent =
          "Cat√°logo subido y procesado correctamente.";
        uploadStatus.className = "mt-3 small text-success";

        uploadForm.reset();
      } catch (err) {
        console.error(err);
        uploadStatus.textContent =
          "Error al subir cat√°logo. Revisa la consola o los logs del backend.";
        uploadStatus.className = "mt-3 small text-danger";
      }
    });

    // ----- ‚ÄúStats‚Äù de demo -----
    function setDemoStats() {
      document.getElementById("statCatalogs").textContent = "5";
      document.getElementById("statParts").textContent = "12.345";
      document.getElementById("statUpdated").textContent =
        new Date().toLocaleString();
    }
    setDemoStats();
  </script>
</body>
</html>
